---
title: "定时任务(Cron)"
category: "自动化任务"
difficulty: "intermediate"
estimated_time: "20 min"
tags: ["cron", "定时任务", "调度", "自动化"]
prerequisites: ["自动化任务概览"]
related_docs: ["自动化任务概览", "心跳", "Webhooks"]
next_steps: ["Webhooks", "Gmail推送"]
last_updated: "2026-01-01"
source: "docs/automation/cron-jobs.md"
---


# 定时任务(Cron)

> **Cron 与心跳的选择?** 参考 [Cron vs Heartbeat](/05-自动化任务/01-自动化任务#cron-vs-heartbeat) 获取指导。

Cron 是 Gateway 的内置调度器。它持久化任务,在正确的时间唤醒 agent,并可选地将输出发送到聊天频道。

如果你需要"每天早上运行"或"20分钟后提醒",Cron 就是你要的机制。

## 快速开始

- Cron 在 **Gateway 内部运行**(不在模型内)
- 任务持久化存储在 `~/.openclaw/cron/`,重启不会丢失调度
- 两种执行样式:
  - **主会话**: 排队系统事件,在下次心跳时运行
  - **隔离**: 在 `cron:<jobId>` 中运行独立的 agent 回合,可选输出发送
- 唤醒是一等公民:任务可以请求"现在唤醒"vs"下次心跳"

## 实用快速入门

创建一次性提醒,验证其存在,并立即运行:

```bash
openclaw cron add \
  --name "提醒" \
  --at "2026-02-01T16:00:00Z" \
  --session main \
  --system-event "提醒: 检查 cron 文档草稿" \
  --wake now \
  --delete-after-run

openclaw cron list
openclaw cron run <job-id> --force
openclaw cron runs --id <job-id>
```

调度一个带有投递的周期性隔离任务:

```bash
openclaw cron add \
  --name "早报" \
  --cron "0 7 * * *" \
  --tz "Asia/Shanghai" \
  --session isolated \
  --message "总结昨晚的更新" \
  --deliver \
  --channel slack \
  --to "channel:C1234567890"
```

## 工具调用等价形式(Gateway cron 工具)

有关规范 JSON 形状和示例,请参阅 [工具调用的 JSON 模式](/05-自动化任务/02-定时任务#json-schema-for-tool-calls)。

## Cron 任务存储位置

Cron 任务默认持久化存储在 Gateway 主机的 `~/.openclaw/cron/jobs.json` 中。
Gateway 将文件加载到内存并在更改时写回,因此仅在 Gateway 停止时手动编辑才是安全的。优先使用 `openclaw cron add/edit` 或 cron 工具调用 API 进行更改。

## 新手友好概述

将 cron 任务视为:**何时**运行 + **什么**要执行。

### 1. 选择调度
- 一次性提醒 → `schedule.kind = "at"` (CLI: `--at`)
- 重复任务 → `schedule.kind = "every"` 或 `schedule.kind = "cron"`
- 如果你的 ISO 时间戳省略了时区,则被视为 **UTC**。

### 2. 选择运行位置
- `sessionTarget: "main"` → 在下次心跳时运行,使用主上下文
- `sessionTarget: "isolated"` → 在 `cron:<jobId>` 中运行独立的 agent 回合

### 3. 选择负载
- 主会话 → `payload.kind = "systemEvent"`
- 隔离会话 → `payload.kind = "agentTurn"`

可选: `deleteAfterRun: true` 在成功的一次性运行后从存储中删除任务。

## 核心概念

### 任务

Cron 任务是一个包含以下内容的存储记录:

- 一个 **调度**(何时运行)
- 一个 **负载**(要执行什么)
- 可选的 **投递**(输出发送到哪里)
- 可选的 **agent 绑定**(`agentId`): 在特定 agent 下运行任务;如果缺失或未知,gateway 回退到默认 agent

任务由稳定的 `jobId` 标识(CLI/Gateway API 使用)。
在 agent 工具调用中,`jobId` 是规范的;为了兼容性,接受 `id`。
任务可以可选地在成功的一次性运行后通过 `deleteAfterRun: true` 自动删除。

### 调度

Cron 支持三种调度类型:

- `at`: 一次性时间戳(自纪元以来的毫秒数)。Gateway 接受 ISO 8601 并强制转换为 UTC。
- `every`: 固定间隔(毫秒)。
- `cron`: 5字段 cron 表达式,带有可选的 IANA 时区。

Cron 表达式使用 `croner`。如果省略时区,使用 Gateway 主机的本地时区。

### 主会话 vs 隔离执行

#### 主会话任务(系统事件)

主任务排队系统事件并可选地唤醒心跳运行器。
它们必须使用 `payload.kind = "systemEvent"`。

- `wakeMode: "next-heartbeat"`(默认): 事件等待下一个计划的心跳
- `wakeMode: "now"`: 事件触发立即心跳

这最适合你需要正常心跳提示 + 主会话上下文的时候。
参见 [心跳](/03-核心概念/心跳)。

#### 隔离任务(专用 cron 会话)

隔离任务在会话 `cron:<jobId>` 中运行专用的 agent 回合。

关键行为:

- 提示以 `[cron:<jobId> <任务名称>]` 为前缀,以便追踪
- 每次运行开始一个 **新的会话 id**(没有先前的对话延续)
- 摘要发布到主会话(前缀 `Cron`,可配置)
- `wakeMode: "now"` 在发布摘要后触发立即心跳
- 如果 `payload.deliver: true`,输出发送到频道;否则保持内部

对嘈杂、频繁或"后台杂务"任务使用隔离任务,这些任务不应该污染你的主聊天历史。

### 负载形状(运行什么)

支持两种负载类型:

- `systemEvent`: 仅主会话,通过心跳提示路由
- `agentTurn`: 仅隔离会话,运行专用的 agent 回合

常用 `agentTurn` 字段:

- `message`: 必需文本提示
- `model` / `thinking`: 可选覆盖(见下文)
- `timeoutSeconds`: 可选超时覆盖
- `deliver`: `true` 将输出发送到频道目标
- `channel`: `last` 或特定频道
- `to`: 特定于频道的收件人(phone/chat/channel id)
- `bestEffortDeliver`: 如果投递失败,避免任务失败

隔离选项(仅适用于 `session=isolated`):

- `postToMainPrefix`(CLI: `--post-prefix`): 主系统中系统事件的前缀
- `postToMainMode`: `summary`(默认)或 `full`
- `postToMainMaxChars`: 当 `postToMainMode=full` 时的最大字符数(默认 8000)

### 模型和思考覆盖

隔离任务(`agentTurn`)可以覆盖模型和思考级别:

- `model`: 提供商/模型字符串(例如 `anthropic/claude-sonnet-4-20250514`)或别名(例如 `opus`)
- `thinking`: 思考级别(`off`, `minimal`, `low`, `medium`, `high`, `xhigh`;仅 GPT-5.2 + Codex 模型)

注意:你也可以在主会话任务上设置 `model`,但它会更改共享的主会话模型。我们建议仅对隔离任务进行模型覆盖,以避免意外的上下文切换。

解析优先级:

1. 任务负载覆盖(最高)
2. 特定于钩子的默认值(例如 `hooks.gmail.model`)
3. Agent 配置默认值

### 投递(频道 + 目标)

隔离任务可以将输出发送到频道。任务负载可以指定:

- `channel`: `whatsapp` / `telegram` / `discord` / `slack` / `mattermost`(插件) / `signal` / `imessage` / `last`
- `to`: 特定于频道的收件人目标

如果省略 `channel` 或 `to`,cron 可以回退到主会话的"last route"(agent 最后回复的地方)。

投递说明:

- 如果设置了 `to`,即使省略了 `deliver`,cron 也会自动投递 agent 的最终输出。
- 当你想要 last-route 投递而没有明确的 `to` 时,使用 `deliver: true`。
- 如果存在 `to`,使用 `deliver: false` 即使存在 `to` 也保持输出内部。

目标格式提醒:

- Slack/Discord/Mattermost(插件)目标应使用显式前缀(例如 `channel:<id>`, `user:<id>`)以避免歧义
- Telegram 主题应使用 `:topic:` 形式(见下文)

#### Telegram 投递目标(主题 / 论坛线程)

Telegram 通过 `message_thread_id` 支持论坛主题。对于 cron 投递,你可以将主题/线程编码到 `to` 字段中:

- `-1001234567890`(仅聊天 id)
- `-1001234567890:topic:123`(首选:显式主题标记)
- `-1001234567890:123`(简写:数字后缀)

也接受前缀目标,如 `telegram:...` / `telegram:group:...`:

- `telegram:group:-1001234567890:topic:123`

## 工具调用的 JSON 模式

直接调用 Gateway `cron.*` 工具时使用这些形状(agent 工具调用或 RPC)。
CLI 标志接受类似 `20m` 的人类持续时间,但工具调用对 `atMs` 和 `everyMs` 使用纪元毫秒数(接受 ISO 时间戳用于 `at` 时间)。

### cron.add 参数

一次性、主会话任务(系统事件):

```json
{
  "name": "提醒",
  "schedule": { "kind": "at", "atMs": 1738262400000 },
  "sessionTarget": "main",
  "wakeMode": "now",
  "payload": { "kind": "systemEvent", "text": "提醒文本" },
  "deleteAfterRun": true
}
```

周期性、带投递的隔离任务:

```json
{
  "name": "早报",
  "schedule": { "kind": "cron", "expr": "0 7 * * *", "tz": "Asia/Shanghai" },
  "sessionTarget": "isolated",
  "wakeMode": "next-heartbeat",
  "payload": {
    "kind": "agentTurn",
    "message": "总结昨晚的更新",
    "deliver": true,
    "channel": "slack",
    "to": "channel:C1234567890",
    "bestEffortDeliver": true
  },
  "isolation": { "postToMainPrefix": "Cron", "postToMainMode": "summary" }
}
```

注意:

- `schedule.kind`: `at`(`atMs`), `every`(`everyMs`), 或 `cron`(`expr`, 可选 `tz`)
- `atMs` 和 `everyMs` 是自纪元以来的毫秒数
- `sessionTarget` 必须是 `"main"` 或 `"isolated"` 并且必须匹配 `payload.kind`
- 可选字段: `agentId`, `description`, `enabled`, `deleteAfterRun`, `isolation`
- 省略时 `wakeMode` 默认为 `"next-heartbeat"`

### cron.update 参数

```json
{
  "jobId": "job-123",
  "patch": {
    "enabled": false,
    "schedule": { "kind": "every", "everyMs": 3600000 }
  }
}
```

注意:

- `jobId` 是规范的;为了兼容性接受 `id`
- 在补丁中使用 `agentId: null` 清除 agent 绑定

### cron.run 和 cron.remove 参数

```json
{ "jobId": "job-123", "mode": "force" }
```

```json
{ "jobId": "job-123" }
```

## 存储和历史

- 任务存储: `~/.openclaw/cron/jobs.json`(Gateway 管理的 JSON)
- 运行历史: `~/.openclaw/cron/runs/<jobId>.jsonl`(JSONL,自动修剪)
- 覆盖存储路径: 配置中的 `cron.store`

## 配置

```json5
{
  cron: {
    enabled: true, // 默认 true
    store: "~/.openclaw/cron/jobs.json",
    maxConcurrentRuns: 1, // 默认 1
  },
}
```

完全禁用 cron:

- `cron.enabled: false`(配置)
- `OPENCLAW_SKIP_CRON=1`(环境变量)

## CLI 快速入门

一次性提醒(UTC ISO,成功后自动删除):

```bash
openclaw cron add \
  --name "发送提醒" \
  --at "2026-01-12T18:00:00Z" \
  --session main \
  --system-event "提醒: 提交费用报告" \
  --wake now \
  --delete-after-run
```

一次性提醒(主会话,立即唤醒):

```bash
openclaw cron add \
  --name "日历检查" \
  --at "20m" \
  --session main \
  --system-event "下次心跳: 检查日历" \
  --wake now
```

周期性隔离任务(投递到 WhatsApp):

```bash
openclaw cron add \
  --name "早间状态" \
  --cron "0 7 * * *" \
  --tz "Asia/Shanghai" \
  --session isolated \
  --message "总结今天的收件箱 + 日历" \
  --deliver \
  --channel whatsapp \
  --to "+15551234567"
```

周期性隔离任务(投递到 Telegram 主题):

```bash
openclaw cron add \
  --name "夜间总结(主题)" \
  --cron "0 22 * * *" \
  --tz "Asia/Shanghai" \
  --session isolated \
  --message "总结今天;发送到夜间主题" \
  --deliver \
  --channel telegram \
  --to "-1001234567890:topic:123"
```

带模型和思考覆盖的隔离任务:

```bash
openclaw cron add \
  --name "深度分析" \
  --cron "0 6 * * 1" \
  --tz "Asia/Shanghai" \
  --session isolated \
  --message "每周深度分析项目进度" \
  --model "opus" \
  --thinking high \
  --deliver \
  --channel whatsapp \
  --to "+15551234567"
```

Agent 选择(多 agent 设置):

```bash
# 将任务固定到 agent "ops"(如果该 agent 缺失则回退到默认)
openclaw cron add --name "运维清理" --cron "0 6 * * *" --session isolated --message "检查运维队列" --agent ops

# 切换或清除现有任务上的 agent
openclaw cron edit <jobId> --agent ops
openclaw cron edit <jobId> --clear-agent
```

手动运行(调试):

```bash
openclaw cron run <jobId> --force
```

编辑现有任务(补丁字段):

```bash
openclaw cron edit <jobId> \
  --message "更新提示" \
  --model "opus" \
  --thinking low
```

运行历史:

```bash
openclaw cron runs --id <jobId> --limit 50
```

无需创建作业的立即系统事件:

```bash
openclaw system event --mode now --text "下次心跳: 检查电池"
```

## Gateway API 表面

- `cron.list`, `cron.status`, `cron.add`, `cron.update`, `cron.remove`
- `cron.run`(强制或到期), `cron.runs`
  对于没有作业的立即系统事件,使用 [`openclaw system event`](/10-命令行工具/01-命令参考)。

## 故障排除

### "什么都没有运行"

- 检查 cron 是否启用: `cron.enabled` 和 `OPENCLAW_SKIP_CRON`
- 检查 Gateway 是否连续运行(cron 在 Gateway 进程内运行)
- 对于 `cron` 调度: 确认时区(`--tz`)与主机时区

### Telegram 投递到错误的位置

- 对于论坛主题,使用 `-100…:topic:<id>` 以便明确和无歧义
- 如果你在日志或存储的"last route"目标中看到 `telegram:...` 前缀,这是正常的;cron 投递接受它们并仍然正确解析主题 ID
