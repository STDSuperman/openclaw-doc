---
title: "架构概览"
category: "核心概念"
difficulty: "进阶"
estimated_time: "20分钟阅读"
tags:
  - 架构
  - Gateway
  - 网关
  - 组件
prerequisites: []
related_docs: ["Gateway 网关", "会话模型", "消息通道"]
next_steps: ["Gateway 网关", "会话模型", "消息通道"]
last_updated: "2026-02-01"
---

# 架构概览

> **TL;DR**: OpenClaw 采用**统一的 Gateway（网关）架构**，作为所有组件的控制平面和数据流中心。

**关键要点**：
- ✅ **单一网关**：每个宿主机只运行一个 Gateway 进程
- ✅ **WebSocket API**：所有客户端通过 WS 连接
- ✅ **消息通道**：Gateway 集成所有消息平台（WhatsApp、Telegram、Discord 等）
- ✅ **Agent 执行**：Pi Agent 通过 RPC 执行推理
- ✅ **工具系统**：统一的工具调用接口
- ✅ **节点系统**：设备节点通过 WS 连接并暴露功能

---

## 整体架构

```text
┌──────────────────────────────────────────────────┐
│         用户消息平台                         │
│  (WhatsApp/Telegram/Discord/iMessage/...)       │
└────────────────┬───────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────────────┐
│          Gateway（统一网关）              │
│   ┌──────────────────────────────────────┐   │
│   │   消息通道管理                   │   │
│   │   会话管理                       │   │
│   │   工具注册                       │   │
│   │   事件分发                       │   │
│   └──────────────────────────────────────┘   │
└────────────┬───────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────────────┐
│  Pi Agent（AI 智能体）              │
│   ├─ 上下文处理                    │
│   ├─ 模型推理                      │
│   ├─ 工具调用                      │
│   └─ 响应生成                      │
└─────────────────────────────────────────────┘
              │
              ▼
┌──────────────────────────────────────────────────┐
│  客户端                             │
├────────────┬──────────────────────────────────┤
│  CLI 工具                             │
│  macOS/iOS/Android 节点             │
│  WebChat / Control UI                 │
└───────────────────────────────────────────┘
```

---

## Gateway（网关）核心

### 职责

Gateway 是 OpenClaw 的**核心控制平面**，负责：

1. **📱 消息通道管理**
   - 维护与所有消息平台的连接
   - 接收入站消息并路由
   - 发送出站消息

2. **💬 会话管理**
   - 创建和管理对话会话
   - 维护会话上下文和历史
   - 会话隔离和路由

3. **🔧 工具系统**
   - 注册和管理可用工具
   - 处理工具调用请求
   - 将工具结果返回给 Agent

4. **📊 事件分发**
   - 向所有客户端推送事件
   - 处理客户端订阅
   - 实现实时通知

5. **🛠️ 认证与授权**
   - WebSocket 认证
   - 设备配对（Pairing）
   - 权限控制

### WebSocket API

所有客户端通过 **WebSocket 协议**与 Gateway 通信：

**连接地址**：`ws://127.0.0.1:18789`（默认）

**协议特点**：
- ✅ **双向通信**：客户端可以发送请求并接收响应
- ✅ **类型化**：所有消息有明确的类型定义（req/res/event）
- ✅ **幂等性**：通过 idempotency key 防止重复执行
- ✅ **事件驱动**：Gateway 主动推送状态更新

**支持的请求类型**（示例）：
- `connect`：连接认证
- `health`：健康检查
- `status`：查询状态
- `agent`：发送消息给 AI
- `send`：发送消息到通道
- `config.*`：配置管理
- `sessions.*`：会话管理

**支持的事件类型**（示例）：
- `agent`：Agent 响应流
- `chat`：新消息通知
- `presence`：在线状态
- `tick`：定期心跳
- `shutdown`：关闭通知

---

## Pi Agent

### 职责

Pi Agent 是 OpenClaw 默认的 AI 智能体，负责：

1. **🧠 上下文处理**
   - 解析系统提示词
   - 注入工作空间文件
   - 管理会话历史
   - 上下文压缩和修剪

2. **🤖 模型推理**
   - 调用 LLM API（Anthropic、OpenAI 等）
   - 处理流式响应
   - 支持多模型和 failover

3. **🔧 工具调用**
   - 解析工具调用请求
   - 执行工具操作（浏览器、文件、命令等）
   - 返回工具执行结果

4. **📝 响应生成**
   - 格式化 AI 响应
   - 添加 Markdown 渲染
   - 处理代码高亮

### 模型选择

OpenClaw 支持多种 LLM 提供商：

| 提供商 | 模型 | 特点 | 适用场景 |
|--------|------|------|----------|
| **Anthropic** | Claude 3.5 Opus | 最强长上下文、最佳推理 | 推荐 |
| **OpenAI** | GPT-4o | 平衡性能与成本 | 通用 |
| **DeepSeek** | DeepSeek-V3 | 中文友好、高性价比 | 中文用户 |
| **Moonshot** | Kimi | 多模态能力 | 特定需求 |

---

## 客户端类型

### 1. CLI 工具

**功能**：
- 通过命令行控制 Gateway
- 发送消息、管理会话、查看状态
- 自动化脚本支持

**特点**：
- ✅ 轻量级、无需 GUI
- ✅ 适合服务器和自动化
- ✅ 完整的命令集

---

### 2. macOS/iOS/Android 节点

**功能**：
- 设备节点连接到 Gateway
- 暴露本地能力（相机、麦克风、Canvas）
- 执行设备本地操作

**特点**：
- ✅ 设备权限管理
- ✅ 配对机制
- ✅ 远程调用能力

---

### 3. WebChat / Control UI

**功能**：
- 浏览器界面聊天
- 实时会话和状态查看
- 配置管理界面

**特点**：
- ✅ 用户友好
- ✅ 响应式设计
- ✅ 实时更新

---

## 数据流向

### 典型消息流程

```
用户（在 WhatsApp）发送消息
    ↓
Gateway 接收消息
    ↓
Gateway 路由到 Agent（main 会话）
    ↓
Pi Agent 处理请求
    ↓
Pi Agent 调用工具（如需要）
    ↓
工具执行（如读取文件）
    ↓
工具结果返回
    ↓
Pi Agent 生成响应
    ↓
Gateway 通过 WebSocket 返回响应流
    ↓
Gateway 推送响应到 WhatsApp
    ↓
用户在 WhatsApp 收到回复
```

---

## 关键设计原则

### 1. 单一网关原则

**原则**：每个宿主机只运行一个 Gateway

**原因**：
- WhatsApp 协议要求单一 WebSocket 连接
- 避免消息重复和冲突
- 简化部署和管理

**实现**：
- Gateway 维护所有消息通道的连接
- 其他客户端只能通过 Gateway 访问消息平台

---

### 2. WebSocket 优先原则

**原则**：WebSocket 是主要通信方式

**原因**：
- 双向实时通信
- 低延迟
- 支持流式响应
- 完整的事件系统

**实现**：
- 所有客户端使用 WS API
- HTTP 仅用于初始认证和文件下载

---

### 3. 会话隔离原则

**原则**：不同的会话相互隔离

**实现**：
- 每个会话独立的历史和上下文
- 不同会话可以使用不同的模型配置
- 群组使用单独会话，避免污染主会话

---

## 扩展性

### 插件系统

OpenClaw 支持插件扩展：

- **通道插件**：Mattermost、Matrix、Zalo 等
- **技能系统**：自定义 AI 能力
- **节点插件**：自定义设备节点

### 配置灵活性

**配置文件**：`~/.openclaw/openclaw.json`

**可配置项**：
- 模型选择和切换
- 工具权限控制
- 会话管理策略
- 消息通道配置
- 安全策略（沙盒模式、DM 配对）

---

## 下一步文档

- [会话模型](./02-会话模型.md) - 深入了解会话管理
- [上下文管理](./03-上下文管理.md) - 理解上下文构建
- [多智能体路由](./04-多智能体路由.md) - 学习会话路由规则
- [消息通道](../02-消息通道/) - 查看各通道连接方式

---

**架构要点总结**：
- 🦞 Gateway 是唯一控制平面
- 📊 WebSocket 提供统一通信
- 🤖 Pi Agent 负责 AI 推理
- 🔌 所有组件通过插件和配置扩展
- 💾 灵活的安全模型（配对、沙盒）

*更多信息请参考 [文档导航](../00-文档导航.md)*
