---
title: "安全配置"
category: "配置与运维"
difficulty: "进阶"
estimated_time: "15分钟阅读"
tags:
  - 安全
  - 认证
  - 配对
  - 沙盒
  - 白名单
prerequisites:
  - "[已完成安装](../00-快速开始/02-5分钟安装指南.md)"
  - "[已完成配置](../00-快速开始/03-向导式配置.md)"
related_docs:
  - ["配置文件说明", "Gateway运维"]
next_steps:
  - ["日志与监控", "故障排查"]
last_updated: "2026-02-01"
source: "docs/gateway/sandbox-vs-tool-policy-vs-elevated.md, docs/gateway/pairing.md"
---

# 安全配置

> **TL;DR**: 通过合理的安全配置保护你的 OpenClaw Gateway，防止未授权访问和滥用。


## 配对机制（Pairing）

### 配对流程

**目的**：安全地允许新设备连接到 Gateway

**流程说明**：
1. 新设备发起连接
2. Gateway 返回配对代码
3. 设备显示配对代码供用户手动输入
4. 用户在 Gateway 或 CLI 中批准配对
5. 设备使用代码获得设备令牌，后续连接无需再配对

### 配对配置

```json5
{
  "gateway": {
    "pairing": {
      "mode": "manual",  // 配对模式：auto（自动）| manual（手动）| disabled（禁用）
      "approveLocal": true,  // 自动批准本地连接（推荐）
      "timeout": 300  // 配对请求超时时间（秒）
      "maxAttempts": 3  // 最大尝试次数
    }
  }
}
```

### 配对类型

| 模式 | 说明 | 适用场景 | 安全性 |
|------|------|----------|--------|
| **auto** | 自动批准 loopback 连接 | 🔒 低 | 本地开发 |
| **manual** | 需要手动输入代码 | 🔒 高 | 生产环境 |
| **disabled** | 禁用配对 | 🔒 高 | 完全信任环境 |

---

## 访问控制

### Gateway 认证

```json5
{
  "gateway": {
    "auth": {
      "token": "your-secure-token-here",  // Gateway 认证令牌
      "mode": "token"  // 认证模式：token| password
      "tokens": {  // 多个令牌支持
        "local": "本地令牌1",
        "remote1": "远程令牌1"
        "remote2": "远程令牌2"
      }
    }
  }
}
```

**认证模式**：

| 模式 | 说明 | 适用场景 |
|------|------|----------|
| **token** | 使用令牌验证 | 推荐（平衡性能和安全） |
| **password** | 使用密码验证 | 不推荐（兼容性差） |

---

## 通道权限管理

### 允许列表（AllowFrom）

**WhatsApp**：
```json5
{
  "channels": {
    "whatsapp": {
      "allowFrom": ["+86138000000"],  // 只允许这些号码
      "groups": {
        "*": {
          "requireMention": true  // 群组需要 @提及
        }
      }
    }
  }
}
```

**Telegram**：
```json5
{
  "channels": {
    "telegram": {
      "allowFrom": [],  // 默认允许所有用户
      "groups": {
        "*": {
          "requireMention": true  // 群组需要 @提及
        }
      }
    }
  }
}
```

### 群组策略

| 策略 | 说明 | 安全性 |
|------|------|--------|
| `requireMention: true` | 群组需要 @提及 | ⭐⭐⭐⭐⭐ |
| `requireMention: false` | 群组可以直接消息 | ⚠️ 安全风险高 |
| `allowFrom: []` | 禁用该群组 | 🔒 最安全 |

---

## 沙盒模式（Sandbox）

### 沙盒类型

| 模式 | 说明 | 适用组件 |
|------|------|----------|
| **off** | 禁用 | 所有组件在主机环境运行 |
| **non-main** | 非主会话启用 | 群组和公开会话隔离运行 |
| **always** | 完全隔离 | 所有会话在隔离环境运行（最安全）|

### 沙盒配置

```json5
{
  "agents": {
    "defaults": {
      "sandbox": {
        "mode": "non-main",  // 非主会话启用沙盒
        "workspace": "~/.openclaw/workspace-sandbox"  // 沙盒专用工作空间
      }
    },
    "list": [  // 为特定智能体配置沙盒
      {
        "name": "production-bot",
        "agentDir": "~/.openclaw/agents/production-bot",
        "workspace": "~/.openclaw/workspace-production",
        "sandbox": {
          "mode": "always",  // 完全隔离
          "allowTools": ["read", "write"]  // 只允许读写工具
          "allowCommands": ["exec"]  // 限制命令白名单
        }
      }
    ]
  }
}
```

### 工具限制

| 工具 | 沙盒模式下 | 说明 |
|------|------------------|------|
| **exec（执行命令）** | ❌ 禁用或限制 | 只允许白名单命令 |
| **browser（浏览器）** | ❌ 完全禁用 | 不允许任何网页访问 |
| **read/write（文件读写）** | ✅ 允许 | 只限沙盒工作空间 |
| **sessions（会话管理）** | ✅ 允许 | 完全访问 |
| **channels（通道操作）** | ✅ 允许 | 完全访问 |
| **web（网页）** | ❌ 完全禁用 | 不允许网页访问 |

---

## DM 安全策略

### 配对 DM

| 策略 | 说明 | 安全性 |
|------|------|--------|
| **启用配对** | ⭐⭐⭐⭐⭐ | 推荐 | 新用户需要配对 |
| **自动批准本地** | ⭐⭐⭐⭐ | ⭐ | 推荐 | loopback 连接自动批准 |
| **超时保护** | ⭐⭐⭐⭐⭐ | ⭐ | 防止无限等待 |

### 陌生消息处理

**默认行为**：未知发送者需要配对

```json5
{
  "security": {
    "unknownSenderPolicy": {
      "mode": "pairing",  // 配对模式
      "requirePairing": true,  // 要求配对
      "timeout": 300,  // 配对超时
      "message": "请使用 /pairing approve {code} 批准此设备"  // 临时消息提示
    }
  }
}
}
```

---

## 高级安全特性

### 1. 网络隔离

```json5
{
  "gateway": {
    "bind": "loopback",  // 只监听本地地址
    "tailscale": {
      "mode": "off"  // 默认禁用 Tailscale
    }
  }
}
```

### 2. 加密连接

```json5
{
  "gateway": {
    "tls": {
      "enabled": true,  // 启用 TLS
      "certPath": "/path/to/cert.pem"  // 证书路径（可选）
      "keyPath": "/path/to/key.pem"  // 私钥路径（可选）
    }
  }
}
```

---

## 安全最佳实践

### 1. 基础安全（必须）

| 实践 | 说明 | 重要性 |
|------|------|----------|
| ✅ **启用配对** | 防止未授权访问 | ⭐⭐⭐⭐⭐ |
| ✅ **使用白名单** | 限制可访问的用户/群组 | ⭐⭐⭐⭐⭐ |
| ✅ **群组需 @提及** | 减少垃圾消息 | ⭐⭐⭐⭐⭐ |
| ✅ **启用沙盒** | 隔离公开会话 | ⭐⭐⭐⭐⭐ |

### 2. 进阶安全（推荐）

| 实践 | 说明 | 重要性 |
|------|------|----------|
| ⭐⭐ **网络隔离** | 只监听 loopback 或使用 VPN | ⭐⭐⭐⭐⭐ |
| ⭐⭐ **使用 Tailscale** | 简化网络管理、提高稳定性 | ⭐⭐⭐⭐⭐ |
| ⭐⭐ **启用 TLS** | 端到端加密 | ⭐⭐⭐⭐⭐ |
| ⭐⭐ **定期更换令牌** | 密钥轮转（每 3 个月） | ⭐⭐⭐⭐⭐ |
| ⭐⭐ **监控日志** | 检测异常访问尝试 | ⭐⭐⭐⭐⭐ |

---

## 安全检查

### openclaw doctor - 安全诊断

```bash
# 运行安全检查
openclaw doctor

# 查看详细报告
openclaw doctor --deep
```

**检查项目**：
- [ ] Gateway 认证配置
- [ ] 通道权限配置
- [ ] 沙盒模式设置
- [ ] 网络绑定配置
- [ ] 证书和密钥状态
- [ ] 配置文件语法验证

---

## 常见问题

### Q1: 忘略用户无法连接？

**A**: 检查 `channels.<channel>.allowFrom` 白名单。

### Q2: 如何禁用配对？

**A**: 设置 `pairing.mode: "disabled"`。

### Q3: 沙盒模式不生效？

**A**: 检查 `agents.defaults.sandbox.mode` 配置，确保群组会话使用 `non-main` 或 `always`。

### Q4: 如何添加多个设备？

**A**: 使用 `/pairing list` 查看所有已配对设备。

---

## 下一步文档

- [日志与监控](./08-日志与监控.md) - 学习日志管理和监控
- [故障排查](./09-故障排查.md) - 深入问题排查
- [配置文件说明](./00-配置文件说明.md) - 查看所有配置项
- [完整配置参考](./02-完整配置参考.md) - 完整配置参考
- [Gateway 运维](./03-Gateway运维.md) - Gateway 运行和管理

---

<ai-search-key>
安全, 配对, 认证, 令牌, 访问控制, 允许列表, 白名单, 群组, 沙盒, 工具限制, DM 安全, 网络隔离, TLS 加密, 安全检查, 最佳实践, 基础安全, 进阶安全, 安全诊断, 常见问题, 配对超时, 设备管理, 多设备, 禁用配对, 白名单配置, 沙盒模式配置, 工具权限限制
</ai-search-key>

**安全配置要点总结**：
- 🤝 **配对机制**：自动/手动/禁用，超时保护
- 🔐 **认证方式**：Token 认证（推荐）或密码认证
- 📋 **访问控制**：允许列表、群组策略
- 🧠️ **沙盒模式**：隔离运行环境，工具权限限制
- 🔒 **网络隔离**：loopback 绑定、Tailscale VPN
- 📊 **TLS 加密**：端到端加密通信
- 🚨️ **安全最佳实践**：基础和进阶安全措施
- 🔍 **安全检查**：使用 `openclaw doctor` 诊断配置

*更多信息请参考 [文档导航](../00-文档导航.md)*
