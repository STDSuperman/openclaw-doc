---
title: "会话管理"
category: "基础使用"
difficulty: "入门"
estimated_time: "15分钟阅读"
tags:
  - 会话
  - 对话历史
  - 管理
prerequisites:
  - "[已完成安装](../00-快速开始/02-5分钟安装指南.md)"
  - "[已完成配置](../00-快速开始/03-向导式配置.md)"
  - "[完成首次连接](../00-快速开始/04-首次连接.md)"
related_docs:
  - ["会话模型", "发送消息", "使用斜杠命令"]
next_steps:
  - ["发送消息", "使用斜杠命令"]
last_updated: "2026-02-01"
source: "docs/concepts/sessions.md, docs/start/wizard.md"
---

# 会话管理

> **TL;DR**: 会话管理让你查看、删除和压缩对话历史，优化 AI 响应性能。


## 查看会话

### 列出所有活跃会话

```bash
# 基础会话列表
openclaw sessions list

# 查看特定通道的会话
openclaw sessions list --channel whatsapp

# 输出格式化（表格）
openclaw sessions list --format table
```

**输出示例**：
```
会话列表:

┌─────────────────────────────────────┬───────┬─────────┐
│ 会话 Key                   │ 模型   │ 消息数 │
├─────────────────────────────────────┼───────┼─────────┤
│ agent:main:whatsapp:dm:+86138  │ claude  │ 42       │
│ agent:main:telegram:+123456789    │ claude  │ 18       │
│ agent:main:discord:guild:123456  │ claude  │ 35       │
└─────────────────────────────────────┴───────┴─────────┘
```

---

### 查看特定会话详情

```bash
# 查看主会话详情
openclaw sessions get --session "agent:main"

# 查看 WhatsApp 私聊详情
openclaw sessions get --session "agent:main:whatsapp:dm:+86138000000"

# 查看特定会话的详细日志
openclaw sessions get --session "agent:main:telegram:+123456789" --verbose
```

**详细信息示例**：
```
会话详情:

会话 Key: agent:main:whatsapp:dm:+86138000000
模型: anthropic/claude-opus-4-5
创建时间: 2026-02-01T10:30:00Z
最后消息: 2026-02-01T16:45:00Z
消息数: 42
状态: 活跃
沙盒模式: 否

上下文:
- 系统提示词: 9,603 tok
- 对话历史: 14,250 tok
- 工具模式: 1,032 tok
总计: 24,885 tok
```

---

## 删除会话

### 删除单个会话

```bash
# 删除特定会话
openclaw sessions delete --session "agent:main:whatsapp:dm:+86138000000"

# 使用会话 Key 删除
openclaw sessions delete --session "agent:main:telegram:+123456789"

# 确认删除（可选）
openclaw sessions delete --session "agent:main:discord:guild:123456" --confirm
```

### 删除所有会话（危险操作）

```bash
# 警告：删除所有会话，包括主会话
openclaw sessions reset

# 只删除特定通道的会话
openclaw sessions reset --channel whatsapp
```

**删除前确认**：
```
⚠️ 警告：此操作将删除所有会话
包括：
  - 主会话 (agent:main)
  - 所有平台会话
  - 对话历史和上下文

此操作无法撤销。

确认删除？(yes/no): 
```

---

## 会话压缩

### 自动压缩

OpenClaw 会在以下情况自动压缩会话：

| 触发条件 | 说明 |
|----------|------|
| 消息数达到阈值（默认 80） | 自动触发 |
| Token 使用过高 | 自动触发 |
| 手动触发 `/compact` | 用户触发 |
| 超过空闲时间（默认 1800s） | 自动清理 |

### 手动压缩当前会话

```bash
# 压缩当前活跃会话
openclaw compact

# 压缩特定会话
openclaw compact --session "agent:main:whatsapp:dm:+86138000000"

# 压缩并显示摘要
openclaw compact --summary-level medium
```

**压缩效果示例**：
```
压缩结果:

保留: 最近 20 条消息
压缩: 22 条旧消息为摘要
节省: 约 8,000 tokens
时间: 1.2s
```

---

## 压缩选项

### 压缩级别

```bash
# 最小压缩（只保留 10 条消息）
openclaw compact --keep 10

# 标准压缩（保留 20 条消息，默认）
openclaw compact

# 保守压缩（保留 30 条消息）
openclaw compact --keep 30
```

### 摘要级别

```bash
# 简短摘要（minimal）
openclaw compact --summary-level minimal

# 中等摘要（medium，默认）
openclaw compact

# 详细摘要（high）
openclaw compact --summary-level high
```

**摘要级别对比**：

| 级别 | 保信息量 | Token 节省 | 适用场景 |
|------|----------|------------|----------|
| minimal | 最少 | 最多 | 高频使用、成本敏感 |
| medium | 中等 | 适中 | 日常使用（推荐）|
| high | 详细 | 较少 | 需要上下文、复杂对话 |

---

## 会话隔离

### 主会话 vs 子会话

**主会话 (agent:main)**：
- ✅ 享有最高权限
- ✅ 完整工具访问
- ⚠️ 适合受信任的环境

**子会话（非 main）**：
- ✅ 隔离运行
- ✅ 可配置不同权限
- ✅ 更安全（推荐公开群组）

### 沙盒模式

```bash
# 查看当前沙盒配置
openclaw config get agents.defaults.sandbox

# 启用非主会话沙盒（推荐）
openclaw config set agents.defaults.sandbox.mode "non-main"
```

**沙盒模式效果**：

| 组件 | 主会话 | 沙盒子会话 |
|------|----------|-------------|
| 文件访问 | 完全访问 | 仅限工作空间 |
| 系统命令 | 完全访问 | 受限命令白名单 |
| 网络访问 | 完全访问 | 禁用 |
| 敏感信息 | 完全可见 | 部分隐藏 |

---

## 最佳实践

### 1. 定期压缩会话

```bash
# 创建定时压缩任务（每月一次）
0 0 * * * /usr/bin/openclaw compact --keep 20 > /dev/null 2>&1
```

### 2. 删除测试会话

```bash
# 列出所有会话，识别测试会话
openclaw sessions list | grep "test"

# 删除测试会话
openclaw sessions delete --session "agent:custom:test:webchat"
```

### 3. 合并相似会话

```bash
# 将相似会话的对话导出并合并到新会话
# （目前需要手动操作，未来可能支持自动合并）
```

### 4. 会话备份

```bash
# 导出会话数据
openclaw sessions export --file sessions-backup-$(date +%Y%m%d).json

# 恢复会话数据
openclaw sessions import --file sessions-backup-20260201.json
```

---

## 常见问题

### Q1: 压缩会话后会话历史丢失？

**A**: 压缩会话时：
- ✅ 保留最近的消息（可配置数量）
- ✅ 将旧消息压缩为摘要
- ⚠️ 一些细节可能会丢失

**解决方案**：使用 `--keep` 参数保留更多消息。

### Q2: 如何恢复已删除的会话？

**A**: 删除的会话无法恢复（除非有备份）。

**预防措施**：
```bash
# 在删除前导出会话
openclaw sessions export --file backup.json

# 确认无误后再删除
openclaw sessions delete --session "key" --confirm
```

### Q3: 会话历史占用太多内存？

**A**: 定期压缩会话和删除不活跃的会话。

```bash
# 1. 压缩所有活跃会话
openclaw compact --all-sessions

# 2. 删除闲置超过 7 天的会话
openclaw sessions prune --idle-days 7
```

### Q4: 如何查看会话的详细日志？

**A**: 使用 `--verbose` 参数查看详细日志。

```bash
# 查看会话的完整处理日志
openclaw sessions get --session "agent:main:whatsapp:dm:+86138000000" --verbose
```

---

## 性能优化

### Token 使用优化

通过合理压缩会话可以显著节省 Token 成本：

| 压缩策略 | Token 节省 | 适用场景 |
|----------|------------|----------|
| 保留 20 条 | 约 40-60% | 日常对话（推荐）|
| 保留 30 条 | 约 20-40% | 需要上下文 |
| 保留 50 条 | 约 10-20% | 长期记忆需求 |

**成本计算示例**：
```
假设场景：
- 每条消息平均 500 tokens
- 平均对话长度 80 条消息
- 模型价格：$15/1M tokens

不压缩成本：
80 条 × 500 tokens = 40,000 tokens
40,000 tokens ÷ 1,000,000 × $15 = $0.60/会话

压缩后（保留 20 条）：
20 条 × 500 tokens = 10,000 tokens
10,000 tokens ÷ 1,000,000 × $15 = $0.15/会话

节省：$0.45/会话（节省 75%）
```

---

## 下一步文档

- [发送消息](./01-发送消息.md) - 学习如何发送消息
- [使用斜杠命令](./02-使用斜杠命令.md) - 查看所有可用命令
- [查看状态](./04-查看状态.md) - 监控 Gateway 和通道状态
- [会话模型](../03-核心概念/02-会话模型.md) - 深入理解会话机制

---

<ai-search-key>
会话, 会话管理, 查看, 删除, 压缩, 会话隔离, 沙盒模式, 最佳实践, 性能优化, Token 优化, 成本计算, 备份, 恢复, 常见问题
</ai-search-key>

**会话管理要点总结**：
- 📊 **查看会话**：`sessions list` 和 `sessions get` 查看所有和特定会话
- 🗑️ **删除会话**：`sessions delete` 删除单个，`sessions reset` 删除所有（危险）
- 📦 **压缩会话**：`compact` 自动或手动压缩，节省 Token
- 🔐 **沙盒模式**：为公开群组隔离运行，提高安全性
- 💰 **成本优化**：合理压缩可节省 40-60% Token 成本
- 📋 **最佳实践**：定期压缩、删除测试会话、备份重要会话

*更多信息请参考 [文档导航](../00-文档导航.md)*
